---
title: 'Prescribing of Salbutamol: Variations Across Seasons and Health Boards'
author: "B249238"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: true
    link-citations: yes
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

#install.packages("janitor")
#install.packages("sf")
#install.packages("plotly")

library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure
library(sf)
library(plotly)
library(scales)

```

# Introduction

Salbutamol is a short-acting beta-agonist (SABA) which acts on the smooth muscle surrounding the bronchi. By inhibiting smooth muscle contraction, it induces bronchodilation which relieves bronchoconstriction, most commonly seen in patients with asthma or COPD(1). Salbutamol is the most commonly prescribed inhaler in Scotland.

This report aims to investigate the trends regarding prescribing of salbutamol inhalers in Scotland in the year 2024, with a focus on variations across the different seasons throughout the year.

It is imortant to consider the influence of these factors on the prescribing of salbutamol, as 

Across the NHS Health Boards, we would expect a greater number of total prescriptions in health boards with a greater overall population. If we look at data

First we load in data files for the prescriptions in 2024. We also load in data for the NHS Health Boards:

We can find the January - June 2024 file and its specific data dictionary here:
<https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community/resource/f0df380b-3f9b-4536-bb87-569e189b727a>

We can find the July - December 2024 file and its specific data dictionary here:
<https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community/resource/f3b9f2e2-66c0-4310-9b8e-734781d2ed0a>

We can find the Health Board names dataset and its specific data dictionary here:
<https://www.opendata.nhs.scot/dataset/geography-codes-and-labels/resource/652ff726-e676-4a20-abda-435b98dd7bdc>

We can find the NHS Health Boards geographical datasets here:
<https://www.data.gov.uk/dataset/27d0fe5f-79bb-4116-aec9-a8e565ff756a/nhs-health-boards-scotland>

We can find the population datasets by health board here:
<https://statistics.ukdataservice.ac.uk/dataset/scotland-s-census-2022-uv102a-age-by-sex>

```{r, include=TRUE, message = FALSE, warning = FALSE, results = 'hide'}

data_jan_jun_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f0df380b-3f9b-4536-bb87-569e189b727a/download/hb_pitc2024_01_06-1.csv") %>% 
  clean_names()

data_jul_dec_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f3b9f2e2-66c0-4310-9b8e-734781d2ed0a/download/hb_pitc2024_07_12-1.csv") %>% 
  clean_names()

HB_lookup <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

NHS_healthboards <- st_read(here("data", "SG_NHS_HealthBoards_2019.shp"))

population_data <- read_csv(here( "data", "UV102a_age_health_board_census.csv"), skip = 10) %>% 
  # Rename the last column to avoid the messy name in column 6
  # and to match column names with the prescription dataset
  rename(Spare = "...6",
         hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  # filter the data so that we get the population of the entire health board
  filter(Age == "All people" & Sex == "All people") %>% 
  # select only the relevant columns
  select(hb_name, hb_population) %>% 
  # change health board names so they match the prescription data
  mutate(hb_name = paste("NHS", hb_name))

```


```{r}

combined_data_2024 <- bind_rows(data_jan_jun_2024, data_jul_dec_2024) %>% 
  clean_names() %>% 
  full_join(HB_lookup, by = c("hbt" = "hb")) %>%
  select(hb_name, hbt:paid_date_month) %>% 
  filter(!is.na(hb_name)) %>% 
  full_join(population_data, 
            by = join_by(hb_name))

salbutamol_inhalers <- c("SALBUTAMOL", "AIROMIR", "ASMALAL", "SALAMOL", "SALBULIN", "VENTOLIN")

salbutamol_inhaler_data <- combined_data_2024 %>%
  filter(str_detect(bnf_item_description, paste(salbutamol_inhalers, collapse = "|"))) %>%
  filter(str_detect(bnf_item_description, "HALER"))

```


# Results

All of the data files were used to produce the following results consisting of a summary table, line graphs and maps.


```{r}



```




## Summary Table

```{r}

salbutamol_inhaler_data_table <- salbutamol_inhaler_data %>%
  group_by(hb_name, hb_population) %>% 
  summarise(
    quantity_per_1k = (sum(paid_quantity)/mean(hb_population))*1000
  ) %>% 
  ungroup() %>% 
  gt() %>% 
  tab_header(
    title = "Prescription of Salbutamol Inhalers across NHS Health Boards"
  ) %>% 
  tab_source_note(
    source_note = "Source: 2024 Prescription datasets from the NHS OpenData sources, Health Board Population data from  Scotland's Census Data in UK Data Service source"
  ) %>% 
  cols_label(
    hb_name = "Health Board",
    hb_population = "Health Board Population",
    quantity_per_1k = "Salbutamol Inhaler Prescriptions Per 1,000 people"
  ) %>% 
  opt_stylize()
salbutamol_inhaler_data_table

```

## Line graphs

```{r}

```


The above graph shows the prescription of salbutamol inhalers throughout the 4 seasons (spring, summer, autumn and winter) in the year 2024. 

```{r pressure, include=TRUE, fig.width=10, fig.height=15}

seasonal_salbutamol_prescriptions <- salbutamol_inhaler_data %>% 
  mutate(season = case_when(paid_date_month %in% c(202403, 202404, 202405) ~ "Spring", paid_date_month %in% c(202406, 202407, 202408) ~ "Summer", paid_date_month %in% c(202409, 202410, 202411) ~ "Autumn", paid_date_month %in% c(202412, 202401, 202402) ~ "Winter"), season = factor(season, levels = c("Spring", "Summer", "Autumn", "Winter"))) %>%
  group_by(hb_name, season, hb_population) %>% 
  summarise(avg_paid_quantity = mean(paid_quantity, na.rm = TRUE)) %>% 
  summarise(avg_quantity_per_1k = (avg_paid_quantity/hb_population)*1000)


line_chart <- ggplot(seasonal_salbutamol_prescriptions, aes(x = season, y = avg_quantity_per_1k, group = hb_name, text = paste(
  "Health Board: ", hb_name, "<br>",
  "Season: ", season, "<br>",
  "Average Quantity per 1,000: ", scales::comma(avg_quantity_per_1k, accuracy = 1)
))) +
  geom_line(color = "darkgreen", linewidth = 1) +
  geom_point() +
  facet_wrap(~ hb_name, ncol = 3, scales = "free") +
  labs(x = "Season", y = "Average Quantity of Salbutamol Inhaler Prescriptions per 1,000 people", title = "Seasonal Salbutamol Prescribing by Health Board") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

line_chart

```


To further analyse the potential correlation between seasons and prescribing of salbutamol inhalers, the above graphs were produced. Each graph shows the trends in salbutamol inhaler prescriptions across the 4 seasons for each of the 14 health boards. 

From this data we can see that 






These graphs above show the variations in monthly prescribing of salbutamol throughout 2024 for each of the Health boards in Scotland


## Maps

```{r}

salbutamol_inhaler_map_data <- NHS_healthboards %>%
  full_join(salbutamol_inhaler_data, 
            by = join_by(HBCode == hbt)) %>% 
  filter(!is.na(HBName)) %>% 
  group_by(hb_name, hb_population) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  summarise(quantity_per_1k = (paid_quantity/hb_population)*1000)

map_salbutamol_inhaler_per_1k <- salbutamol_inhaler_map_data %>%
  ggplot(aes(fill = quantity_per_1k, text = paste("Health Board: ", hb_name, "<br>Prescriptions per 1,000: ", comma(quantity_per_1k, accuracy = 1)))) +
  geom_sf(colour = "black", size = 0.1) +
  scale_fill_distiller(palette = "Blues", direction = 1, name = "No. of Prescriptions per 1,000 people", labels = scales::comma_format()) +
  labs(title = "Salbutamol Inhaler Prescriptions by Health Board") +
  theme_void() +
  theme(plot.title = element_text(face = "bold", size = 16), plot.subtitle = element_text(size = 8))  

ggplotly(map_salbutamol_inhaler_per_1k, tooltip = "text") %>% 
  config(displayModeBar = FALSE)

```

This map shows 


# Conclusions


Include Limitations of data and next steps (particularly in terms of data that would allow for further analysis)

However, there are some limitations in the data used in this report. For instance, this report only investigates the available data for the year 2024. Therefore, we cannot conclude that the trends seen in the above data is representative of the seasonal trends in salbutamol inhaler prescriptions in Scotland. It is also difficult to come to a conclusion with the avaiable data whether the trends observed are directly caused by seasonal changes in the environment and weather, as opposed to being correlated with seasonal changes. Lack of acknowledgement of potential confounding variables is a limiting factor in this report.

Regarding potential next steps, it would be useful to research further into seasonal trends in other years along with 2024 to investigate whether the trends observed above are yearly, or if they are different each year. 

# References

1.Marques L, Vale N. Salbutamol in the management of asthma: A review. International Journal of Molecular Sciences [Internet]. 2022;23(22). Available from: https://pmc.ncbi.nlm.nih.gov/articles/PMC9696300/

2.